<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Pro Chat Widget</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --primary:#06b6d4; --primary-600:#0891b2; --bg:#fff; --muted:#6b7280;
  --surface:#f8fafc; --bubble-bot:#f1f5f9; --bubble-user:#dcfce7;
  --shadow-xl:0 18px 40px rgba(2,6,23,0.12); --radius:16px;
  font-family:"Inter",system-ui,-apple-system,"Segoe UI",Roboto,Arial;
}

/* Root container */
#chat-root{
  position:fixed; right:20px; bottom:20px; z-index:100000; display:grid; gap:12px; pointer-events:none;
}

/* Floating toggle button */
.chat-toggle{
  pointer-events:auto; width:64px; height:64px; border-radius:999px;
  background:linear-gradient(135deg,var(--primary),var(--primary-600));
  box-shadow:var(--shadow-xl); display:flex; align-items:center; justify-content:center;
  color:#fff; cursor:pointer; transition:.2s;
}
.chat-toggle:hover{transform:scale(1.06) translateY(-2px);}
.chat-toggle svg{width:26px;height:26px;}
.badge{position:absolute;top:-6px;right:-6px;background:#ff3b30;color:#fff;min-width:18px;height:18px;font-size:11px;border-radius:999px;display:flex;align-items:center;justify-content:center;padding:0 6px;box-shadow:0 6px 18px rgba(2,6,23,0.18);pointer-events:none;}

/* Panel */
.panel{
  pointer-events:auto; position:absolute; right:0; bottom:80px;
  width:380px; max-width:calc(100vw - 24px); max-height:85vh;
  background:var(--bg); border-radius:var(--radius); box-shadow:var(--shadow-xl);
  display:flex; flex-direction:column; opacity:0; transform:translateY(20px) scale(.96);
  transition:all .25s cubic-bezier(.2,.9,.3,1); overflow:hidden;
}
.panel.open{opacity:1; transform:translateY(0) scale(1);}

/* Header */
.header{
  display:flex; align-items:center; gap:12px; padding:14px;
  border-bottom:1px solid #eef2f7; background:linear-gradient(90deg,#fff,#f9ffff);
  flex-shrink:0;
}
.logo{width:40px; height:40px; border-radius:10px; background:linear-gradient(180deg,var(--primary),var(--primary-600));
  display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700; font-size:15px; flex-shrink:0;}
.header-text{display:flex; flex-direction:column; flex:1; min-width:0; overflow:hidden;}
.title{font-weight:700; color:#0f1724; font-size:15px; white-space:nowrap; text-overflow:ellipsis; overflow:hidden;}
.subtitle{font-size:12px; color:var(--muted); white-space:nowrap; text-overflow:ellipsis; overflow:hidden;}
.actions{display:flex; gap:6px; flex-shrink:0;}
.icon-btn{background:none; border:0; padding:6px; cursor:pointer; color:var(--muted); font-size:16px; line-height:1;}

/* Messages */
.messages{flex:1; overflow-y:auto; padding:16px; display:flex; flex-direction:column; gap:12px; background:linear-gradient(180deg,var(--surface),#fff);}
.msg-row{display:flex; flex-direction:column; max-width:100%;}
.msg{padding:12px 14px; border-radius:14px; font-size:14px; line-height:1.4; word-break:break-word; box-shadow:0 2px 8px rgba(0,0,0,0.05); max-width:80%;}
.msg.bot{background:var(--bubble-bot); align-self:flex-start; border-bottom-left-radius:6px;}
.msg.user{background:var(--bubble-user); align-self:flex-end; border-bottom-right-radius:6px;}
.meta{font-size:11px; color:var(--muted); margin-top:4px; align-self:flex-end;}

/* Typing */
.typing{background:var(--bubble-bot); padding:8px 12px; border-radius:12px; display:inline-flex; gap:6px;}
.dot{width:7px; height:7px; background:#cbd5e1; border-radius:50%; animation:bounce 1s infinite;}
.dot:nth-child(2){animation-delay:.15s;} .dot:nth-child(3){animation-delay:.3s;}
@keyframes bounce{0%,100%{transform:translateY(0);opacity:.4}50%{transform:translateY(-6px);opacity:1}}

/* Composer */
.composer{border-top:1px solid #eef2f7; padding:10px; display:flex; gap:8px;}
.composer input{flex:1; padding:10px 14px; border:1px solid #e6eef5; border-radius:999px; font-size:14px;}
.composer input:focus{outline:none; border-color:var(--primary);}
.btn-send{background:var(--primary); color:#fff; border:0; border-radius:999px; padding:10px 16px; font-weight:600; cursor:pointer;}
.btn-send:disabled{opacity:.5; cursor:not-allowed;}

/* Quick replies */
.quick{padding:8px 12px; display:flex; gap:8px; flex-wrap:wrap; border-top:1px dashed #f1f5f9;}
.quick button{background:#f8fafc; border:1px solid #eef2f7; padding:8px 12px; border-radius:999px; font-size:13px; cursor:pointer;}
.quick button:hover{background:#f1f5f9;}

/* Responsive */
@media(max-width:640px){
  .panel{width:calc(100vw - 24px); height:85vh; bottom:80px;}
  .messages{padding:14px;}
}
</style>
</head>
<body>

<div id="chat-root" aria-live="polite">
  <div id="chat-panel" class="panel" role="dialog" aria-label="Chat" style="display:none">
    <div class="header">
      <div class="logo">WB</div>
      <div class="header-text">
        <div class="title">Website Bot</div>
        <div class="subtitle">Services, pricing & booking</div>
      </div>
      <div class="actions">
        <button id="minimize" class="icon-btn">—</button>
        <button id="close" class="icon-btn">✕</button>
      </div>
    </div>
    <div id="messages" class="messages"></div>
    <div id="quick" class="quick">
      <button data-q="Which services are under $100?">Under $100</button>
      <button data-q="How do I book a service?">How to book</button>
      <button data-q="If I take a $50 service for 12 months how much?">$50 × 12</button>
    </div>
    <div class="composer">
      <input id="input" type="text" placeholder="Ask about services, pricing or booking..." />
      <button id="send" class="btn-send">Send</button>
    </div>
  </div>

  <div id="toggle" class="chat-toggle" tabindex="0">
    <svg viewBox="0 0 24 24" fill="none"><path d="M21 15a2 2 0 0 1-2 2H8l-5 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" fill="white"/></svg>
    <div id="unread" class="badge" style="display:none">1</div>
  </div>
</div>

<script>
(() => {
  const toggle=document.getElementById('toggle');
  const panel=document.getElementById('chat-panel');
  const messagesEl=document.getElementById('messages');
  const inputEl=document.getElementById('input');
  const sendBtn=document.getElementById('send');
  const unreadEl=document.getElementById('unread');
  const quick=document.getElementById('quick');
  const minimizeBtn=document.getElementById('minimize');
  const closeBtn=document.getElementById('close');

  let openState=false, unread=0;

  function timeNow(){const d=new Date(); return d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});}
  function addMessage({who='bot',text='',time=''}){
    const row=document.createElement('div'); row.className='msg-row';
    const bubble=document.createElement('div'); bubble.className='msg '+(who==='user'?'user':'bot'); bubble.innerHTML=text;
    row.appendChild(bubble);
    if(time){const meta=document.createElement('div'); meta.className='meta'; meta.textContent=time; row.appendChild(meta);}
    messagesEl.appendChild(row); messagesEl.scrollTop=messagesEl.scrollHeight;
  }

  function setTyping(on=true){
    const existing=document.getElementById('typing');
    if(on && !existing){
      const r=document.createElement('div'); r.className='msg-row'; r.id='typing';
      const t=document.createElement('div'); t.className='typing'; t.innerHTML='<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
      r.appendChild(t); messagesEl.appendChild(r); messagesEl.scrollTop=messagesEl.scrollHeight;
    } else if(!on && existing){ existing.remove(); }
  }

  function openPanel(){panel.style.display='flex'; setTimeout(()=>panel.classList.add('open'),10); openState=true; unread=0; unreadEl.style.display='none'; inputEl.focus();}
  function closePanel(){panel.classList.remove('open'); setTimeout(()=>panel.style.display='none',200); openState=false;}
  function togglePanel(){openState?closePanel():openPanel();}
  function escapeHtml(s){return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]);}

  async function sendMessage(text){if(!text)return; addMessage({who:'user',text:escapeHtml(text),time:timeNow()}); inputEl.value=''; setTyping(true); sendBtn.disabled=true;
    try{
      const res=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:text})});
      const json=await res.json(); setTyping(false); sendBtn.disabled=false;
      if(res.ok && json?.reply){addMessage({who:'bot',text:escapeHtml(json.reply),time:timeNow()});}
      else{const err=json?.detail||json?.error||'No response'; addMessage({who:'bot',text:'⚠️ Error: '+escapeHtml(err),time:timeNow()}); if(!openState){unread++; unreadEl.textContent=unread; unreadEl.style.display='flex';}}
    }catch(e){setTyping(false); sendBtn.disabled=false; addMessage({who:'bot',text:'⚠️ Network error. Please check server.',time:timeNow()}); if(!openState){unread++; unreadEl.textContent=unread; unreadEl.style.display='flex';}}
  }

  toggle.addEventListener('click',togglePanel); toggle.addEventListener('keydown',e=>{if(e.key==='Enter'||e.key===' ')togglePanel();});
  closeBtn.addEventListener('click',closePanel); minimizeBtn.addEventListener('click',closePanel);
  sendBtn.addEventListener('click',()=>{const v=inputEl.value.trim(); if(!v)return; sendMessage(v);});
  inputEl.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault(); sendBtn.click();}});
  quick.addEventListener('click',e=>{const btn=e.target.closest('button[data-q]'); if(!btn)return; const q=btn.getAttribute('data-q'); if(!openState)openPanel(); sendMessage(q);});

  addMessage({who:'bot',text:'Hi! I can help with services, pricing and booking. Try: "Which services are under $100?"',time:timeNow()});
  document.addEventListener('keydown',e=>{if(e.key==='Escape' && openState) closePanel();});
})();
</script>
</body>
</html>
